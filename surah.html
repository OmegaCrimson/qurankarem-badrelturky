<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>سورة</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Amiri&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { font-family: 'Amiri', serif; background: #f8f9fa; }
    .ayah { margin-bottom: 1rem; font-size: 1.4rem; line-height: 2.2; }
    .ayah span { font-size: 0.9rem; margin-left: 0.5rem; color: #198754; }
    .verses { background: #fff; padding: 1.5rem; border-radius: 0.5rem; margin-top: 2rem; }
  </style>
</head>
<body>
  <header class="bg-success text-white text-center p-3">
    <h1>القرآن الكريم بصوت الشيخ <span id="reciter-name">...</span></h1>
  </header>

  <main class="container my-4">
    <div class="card shadow p-4" id="surah-card">
      <h2 class="text-center" id="surah-title">تحميل...</h2>
      <ul class="list-group mb-3" id="surah-details"></ul>

      <div class="mb-3">
        <label for="riwayaSelect" class="form-label">اختر الرواية:</label>
        <select id="riwayaSelect" class="form-select"></select>
      </div>

      <audio controls preload="none" class="w-100 mb-3" id="surah-audio"></audio>
      <div id="verses" class="verses"></div>
      <a href="index.html" class="btn btn-outline-success mt-3">⬅ العودة إلى القائمة</a>
    </div>
  </main>

  <footer class="text-center text-muted p-3">
    &copy; <span id="year"></span> القرآن الكريم بصوت الشيخ <span id="reciter-footer">...</span>
  </footer>

  <script>
    const params = new URLSearchParams(window.location.search);
    const surahId = parseInt(params.get('id'));
    const selectedReciterId = params.get('reciter') || localStorage.getItem('selectedReciter') || 'bader-hafs';

    const reciterNameEl = document.getElementById('reciter-name');
    const reciterFooterEl = document.getElementById('reciter-footer');
    const riwayaSelect = document.getElementById('riwayaSelect');
    const audio = document.getElementById('surah-audio');

    let allReciters = [];
    let currentReciter = null;
    let currentSurah = null;

    fetch('reciters.json')
      .then(res => res.json())
      .then(data => {
        allReciters = data.reciters;

        const baseReciterName = selectedReciterId.split('-')[0];
        const availableRiwayat = allReciters.filter(r => r.id.startsWith(baseReciterName));

        // Populate riwaya dropdown
        availableRiwayat.forEach(r => {
          const option = document.createElement('option');
          option.value = r.id;
          option.textContent = r.riwaya;
          riwayaSelect.appendChild(option);
        });

        // Set selected riwaya
        const saved = selectedReciterId;
        riwayaSelect.value = saved;

        updateReciterInfo(saved);
        localStorage.setItem('selectedReciter', saved);

        return fetch('data.json');
      })
      .then(res => res.json())
      .then(data => {
        currentSurah = data.surahs.find(s => s.id === surahId);
        if (!currentSurah) {
          document.getElementById('surah-title').textContent = 'السورة غير موجودة';
          return;
        }

        document.title = `سورة ${currentSurah.name}`;
        document.getElementById('surah-title').textContent = `سورة ${currentSurah.name}`;

        const details = document.getElementById('surah-details');
        details.innerHTML = `
          <li class="list-group-item">الترتيب: ${currentSurah.id}</li>
          <li class="list-group-item">عدد الآيات: ${currentSurah.ayahs}</li>
          <li class="list-group-item">نوعها: ${currentSurah.type}</li>
          <li class="list-group-item">أسماء أخرى: ${currentSurah.other_names.join(", ")}</li>
          <li class="list-group-item">الموضوعات: ${currentSurah.topics.join(", ")}</li>
        `;

        updateAudioSource();
      });

    function updateReciterInfo(id) {
      currentReciter = allReciters.find(r => r.id === id);
      reciterNameEl.textContent = currentReciter.reciter;
      reciterFooterEl.textContent = currentReciter.reciter;
    }

    function updateAudioSource() {
      if (!currentReciter || !currentSurah) return;
      const paddedId = String(currentSurah.id).padStart(3, '0');
      audio.src = `${currentReciter.baseURL}${paddedId}.mp3`;
      audio.dataset.surahId = currentSurah.id;
    }

    riwayaSelect.addEventListener('change', () => {
      const newId = riwayaSelect.value;
      localStorage.setItem('selectedReciter', newId);
      updateReciterInfo(newId);
      updateAudioSource();
    });

    // Load verses from XML
    fetch('quran-uthmani.xml')
      .then(res => res.text())
      .then(xmlText => {
        const parser = new DOMParser();
        const xml = parser.parseFromString(xmlText, "application/xml");
        const surahNode = xml.querySelector(`sura[index="${surahId}"]`);
        if (!surahNode) return;

        const verses = surahNode.querySelectorAll('aya');
        const versesContainer = document.getElementById('verses');
        verses.forEach(aya => {
          const text = aya.getAttribute('text');
          const index = aya.getAttribute('index');
          const p = document.createElement('p');
          p.className = 'ayah';
          p.innerHTML = `<span>(${index})</span> ${text}`;
          versesContainer.appendChild(p);
        });
      });

    document.getElementById('year').textContent = new Date().getFullYear();
  </script>
</body>
</html>